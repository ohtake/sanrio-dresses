<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/Character.jsx | sanrio-wardrobe</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Character.jsx~Character.html">Character</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/colors.js~ColorData.html">ColorData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data_file.js~DataFile.html">DataFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/photo.js~Photo.html">Photo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/srcset_providers.js~FlickrSrcsetProvider.html">FlickrSrcsetProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/srcset_providers.js~Instagram2SrcsetProvider.html">Instagram2SrcsetProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/srcset_providers.js~InstagramSrcsetProvider.html">InstagramSrcsetProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/srcset_providers.js~PicasaSrcsetProvider.html">PicasaSrcsetProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-JustifiedLayout">JustifiedLayout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-applyThemeToBody">applyThemeToBody</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getRouterHistory">getRouterHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-openFeedback">openFeedback</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sendGoogleAnalyticsEvent">sendGoogleAnalyticsEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-withFullWidth">withFullWidth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RepresentiveColors">RepresentiveColors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-themeDarkV1">themeDarkV1</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-themeLightV1">themeLightV1</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Character.jsx</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import React from &apos;react&apos;;
import PropTypes from &apos;prop-types&apos;;

import CircularProgress from &apos;@material-ui/core/CircularProgress&apos;;
import Grid from &apos;@material-ui/core/Grid&apos;;
import TextField from &apos;@material-ui/core/TextField&apos;;

import ActionSearch from &apos;@material-ui/icons/Search&apos;;

import isEqual from &apos;lodash/isEqual&apos;;
import throttle from &apos;lodash/throttle&apos;;

import ColorSelector from &apos;./ColorSelector&apos;;
import DataFile from &apos;./data_file&apos;;
import DetailView from &apos;./DetailView&apos;;
import Gallery from &apos;./Gallery&apos;;

import Photo from &apos;./photo&apos;;
import * as utils from &apos;./utils&apos;;

class SearchParams {
  constructor() {
    this.clear();
  }

  /** @returns {boolean} */
  isEmpty() {
    if (this.regexps.length) return false;
    if (this.colorIds.length) return false;
    return true;
  }

  clear() {
    this.regexps = [];
    this.colorIds = [];
  }

  /**
   * @param {Photo} photo
   * @returns {boolean}
   */
  match(photo) {
    if (!this.regexps.every((re) =&gt; photo.match(re))) return false;
    if (!this.colorIds.every((c) =&gt; photo.data.colors.indexOf(c) &gt;= 0)) return false;
    return true;
  }
}

export default class Character extends React.Component {
  constructor() {
    super();
    this.state = { allPhotos: null, photos: [], error: null };
    this.searchParams = new SearchParams();

    this.refColor = React.createRef();
    this.refText = React.createRef();

    this.colorChanged = this.colorChanged.bind(this);
    this.handleSearchIconClick = this.handleSearchIconClick.bind(this);
    this.handleSearchTextChanged = throttle(this.handleSearchTextChanged.bind(this), 500);
    this.handleSearchTextKeyDown = this.handleSearchTextKeyDown.bind(this);
    this.handleSearchTextBlur = this.handleSearchTextBlur.bind(this);
  }

  componentDidMount() {
    this.loadPhotos();
  }

  componentDidUpdate(prevProps) {
    const { match } = this.props;
    const { chara, title } = match.params;
    if (prevProps.match.params.chara !== chara) {
      this.loadPhotos();
    } else if (prevProps.match.params.title !== title) {
      this.updateLightbox(title);
    }
  }

  /**
   * @private
   * @returns {void}
   */
  loadPhotos() {
    const { match } = this.props;
    const { chara } = match.params;
    const { setTitle } = this.context;
    const df = DataFile.findByName(chara);
    setTitle(df.getDisplayName());
    this.setState({
      allPhotos: null,
      photos: [],
    });
    this.loadPhotosAsync();
  }

  async loadPhotosAsync() {
    const { match } = this.props;
    const { chara, title } = match.params;
    try {
      const photos = await Photo.loadPhotos(chara);
      this.setState({
        allPhotos: photos,
        photos,
      });
      this.clearSearch();
      this.updateLightbox(title);
    } catch (err) {
      this.setState({
        error: err,
      });
    }
  }

  /**
   * @private
   * @param {string?} title
   * @returns {void}
   */
  updateLightbox(title) {
    const { photos, chara } = this.state;
    if (title) {
      if (photos) {
        const index = photos.findIndex((p) =&gt; title === p.data.title);
        if (index &gt;= 0) {
          this.setState({ index });
        } else {
          utils.getRouterHistory().replace(`/chara/${chara}`);
        }
      }
    } else {
      this.setState({ index: -1 });
    }
  }

  execSearch() {
    const { allPhotos, photos } = this.state;
    if (!allPhotos) return;
    if (this.searchParams.isEmpty()) {
      if (allPhotos !== photos) {
        this.setState({ photos: allPhotos });
      }
    } else {
      const filtered = allPhotos.filter((p) =&gt; this.searchParams.match(p));
      if (!isEqual(filtered, photos)) {
        this.setState({ photos: filtered });
      }
    }
  }

  clearSearch() {
    this.searchParams.clear();
    if (this.refText.current) this.refText.current.value = &apos;&apos;;
    if (this.refColor.current) this.refColor.current.clear();
  }

  handleSearchIconClick() {
    this.refText.current.focus();
  }

  handleSearchTextChanged() {
    const text = this.refText.current.value;
    const terms = text.split(/[ \u3000]/).filter((t) =&gt; t.length &gt; 0); // U+3000 = full width space
    const termsEscaped = terms.map((t) =&gt; t.replace(/[-/\\^$*+?.()|[\]{}]/g, &apos;\\$&amp;&apos;));
    const res = termsEscaped.map((te) =&gt; new RegExp(te, &apos;i&apos;));
    this.searchParams.regexps = res;
    this.execSearch();
  }

  handleSearchTextKeyDown(e) {
    switch (e.keyCode) {
      case 13: // Enter
        this.refText.current.blur(); // To hide keyboard on mobile phones
        e.preventDefault();
        break;
      default:
        break;
    }
  }

  handleSearchTextBlur() {
    const text = this.refText.current.value.trim();
    if (text) {
      const { match } = this.props;
      const { chara } = match.params;
      utils.sendGoogleAnalyticsEvent(&apos;textsearch&apos;, &apos;blur&apos;, `${chara} ${text}`);
    }
  }

  colorChanged(sender) {
    const colors = sender.listActiveIds();
    this.searchParams.colorIds = colors;
    this.execSearch();
  }

  render() {
    const { match } = this.props;
    const { chara } = match.params;
    const {
      error, allPhotos, photos, index,
    } = this.state;
    const message = (allPhotos === null &amp;&amp; [&lt;CircularProgress /&gt;, `Loading ${chara}...`])
      || (!this.searchParams.isEmpty() &amp;&amp; `Displaying ${photos.length} of ${allPhotos.length} items`)
      || null;
    if (error) throw error;
    return (
      &lt;React.Fragment&gt;
        &lt;ColorSelector innerRef={this.refColor} onChanged={this.colorChanged} /&gt;
        &lt;Grid container alignItems=&quot;flex-end&quot;&gt;
          &lt;Grid item&gt;
            &lt;ActionSearch style={{ padding: &apos;0 8px&apos; }} onClick={this.handleSearchIconClick} /&gt;
          &lt;/Grid&gt;
          &lt;Grid item&gt;
            &lt;TextField inputRef={this.refText} placeholder=&quot;Search text&quot; onChange={this.handleSearchTextChanged} onKeyDown={this.handleSearchTextKeyDown} onBlur={this.handleSearchTextBlur} /&gt;
          &lt;/Grid&gt;
        &lt;/Grid&gt;
        {message ? &lt;div&gt;{message}&lt;/div&gt; : &lt;div style={{ height: 8 }} /&gt; }
        &lt;Gallery photos={photos} chara={chara} /&gt;
        &lt;DetailView chara={chara} photos={photos} index={index} /&gt;
      &lt;/React.Fragment&gt;
    );
  }
}
Character.propTypes = {
  match: PropTypes.shape({
    params: PropTypes.shape({
      chara: PropTypes.string,
      title: PropTypes.string,
    }),
  }).isRequired,
};
Character.contextTypes = {
  setTitle: PropTypes.func,
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
